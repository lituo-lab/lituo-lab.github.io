---
title: 从电机电磁原理到FOC控制
date: 2025-10-26
categories: [电机控制, 控制系统]
tags: [FOC, 矢量控制, 电机控制, 控制系统, 无感控制]
math: true
---

## 一. 摘要：FOC——高性能电机的控制算法

FOC彻底颠覆了传统的电机驱动方式，使无刷电机（BLDC/PMSM）达到了前所未有的效率和动态响应。本文将学习和探讨FOC的核心机制：从电磁原理出发，学习FOC如何巧妙地将复杂的交流控制转化为直流控制，并探讨电流环饱和、弱磁控制等问题。

---

## 二. FOC的数学核心——坐标变换与直流化

### 2.1 三相电流与空间矢量

三相对称定子绕组产生的三相电流为：

$$
\begin{aligned}
I_a &= I_m \cos(\omega t)\\
I_b &= I_m \cos\left(\omega t - \frac{2\pi}{3}\right)\\
I_c &= I_m \cos\left(\omega t + \frac{2\pi}{3}\right)
\end{aligned}
$$

### 2.2 空间矢量理论

电流产生磁场（安培定律），磁场是矢量，可以叠加。因此，电流也可以看作矢量，通过矢量运算来合成和控制磁场。

在**空间矢量理论（Space Vector）**中，这三相电流可以等效为一个在空间中**旋转的电流矢量**：

$$
\vec{I_s} = I_m e^{j\theta_{elec}}
$$

其中：

- **幅值**：$\|\vec{I_s}\| = \frac{3}{2} I_m$，代表合成后的电流矢量幅值
- **角度**：$\theta_{elec} = \omega t + \theta_0$（电气角），表示该矢量在**定子空间坐标系**中的方向

Clarke变换和Park变换都是这两个矢量的不同表达形式。

坐标变换的路径如下：

$$
\text{三相交流 } I_{a,b,c} \xrightarrow{\text{Clarke}} I_{\alpha, \beta} \xrightarrow{\text{Park}(\theta)} I_{d, q} \text{ 直流}
$$

### 2.3 Clarke变换：三相到两相的降维

**Clarke变换**将三相电流 $I_{a,b,c}$ 投影到两个**正交的静止虚拟线圈**上：

$$
\begin{bmatrix} I_\alpha \\ I_\beta \end{bmatrix} = \frac{2}{3}
\begin{bmatrix} 1 & -\frac{1}{2} & -\frac{1}{2} \\ 0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \end{bmatrix}
\begin{bmatrix} I_a \\ I_b \\ I_c \end{bmatrix}
$$

**物理意义**：

- $I_\alpha$：与A相线圈**完全重合**的虚拟线圈电流
- $I_\beta$：与A相线圈**垂直**（空间上90°）的虚拟线圈电流
- **本质**：将三维空间中的电流矢量（$I_a, I_b, I_c$）降维到二维平面（$\alpha-\beta$ 平面）
- **核心结论**：任何三相电流产生的磁场，都可以等效为两个正交线圈产生的磁场之和

> **Note**: 实际应用中常使用2/3做归一化处理，使得 $I_\alpha = I_a$，$I_\beta = \frac{1}{\sqrt{3}}(I_b - I_c)$。

### 2.4 Park变换：静止坐标系到旋转坐标系

**Park变换**将静止的 $\alpha-\beta$ 坐标系旋转，使其与转子磁场方向对齐：

$$
\begin{bmatrix} I_d \\ I_q \end{bmatrix} = 
\begin{bmatrix} \cos\theta_{rotor} & \sin\theta_{rotor} \\ -\sin\theta_{rotor} & \cos\theta_{rotor} \end{bmatrix}
\begin{bmatrix} I_\alpha \\ I_\beta \end{bmatrix}
$$

**坐标系定义**：

- **d轴（Direct axis）**：与转子磁场方向**对齐**
- **q轴（Quadrature axis）**：与转子磁场方向**正交**

**物理意义**：

- $I_d$：与转子磁场平行的虚拟线圈电流分量（产生磁通，Direct axis）
- $I_q$：与转子磁场垂直的虚拟线圈电流（产生转矩，Quadrature axis）

---

## 三. 电机的物理基础——力矩是如何诞生的？

理解FOC，必须先回到电磁学的基本原理：电流如何在磁场中产生力矩。

### 3.1 电磁力与转矩的产生

电机工作的原理基于著名的**洛伦兹力（安培力）**定律。

当一个载流导体（定子绕组）置于磁场（转子永磁体产生的磁场）中时，该导体将受到一个力的作用：

$$
\vec{F} = I (\vec{L} \times \vec{B})
$$

其中：

- **B**（磁场强度）：由转子的永磁体提供
- **I**（电流）：由控制器施加给定子绕组的电流  
- **L**（导体长度）：绕组的有效长度
- **F**（电磁力）：导体受到的力，这个力作用在电机轴的半径上，产生电磁转矩 **T**，驱动转子旋转

### 3.2 FOC的目标：实现力矩和电流的精准解耦

传统控制难以实现高性能，主要原因在于：

- 定子电流是三相交流电，其方向和大小随转子位置不断变化
- 导致力矩输出不稳定，难以精确控制

**FOC的核心目标**：在任何转子位置，都能精确地、线性地控制产生力矩的有效电流。

对于永磁同步电机（PMSM），转子永磁体提供一个空间上的转子磁场：

$$
\vec{B_r} = B_{\max} e^{j\theta_{rotor}}
$$

其中：

- **幅值**：$\|\vec{B_r}\| = B_{\max}$，表示转子永磁体磁场的强度
- **角度**：$\theta_{rotor}$，是其在空间中的位置（电气角），随转子机械运动变化

> **Note**: 对永磁同步电机来说，转子磁场是"主磁场"，定子电流则是"励磁/转矩磁场"。

### 3.3 功角与电流矢量分解

定义**功角（Load Angle）** $\delta$ 为定子电流矢量与转子磁场矢量之间的相位差：

$$
\delta = \theta_{elec} - \theta_{rotor}
$$

**电流矢量的分解**：

利用功角关系：

$$
\begin{aligned}
I_d &= |\vec{I_s}| \cos(\delta) \quad \text{（产生磁通的分量）} \\
I_q &= |\vec{I_s}| \sin(\delta) \quad \text{（产生转矩的分量）}
\end{aligned}
$$

> **结论**: 通过FOC的解耦，我们将力矩的控制权完全赋予了 **$I_q$**。这意味着我们对电机转矩的控制，就像控制一个直流电源一样简单且精确。

**功角的物理意义**：

- 当 $\delta=90^\circ$（电气角）时，两矢量**正交**，力矩最大
- 当 $\delta=0^\circ$ 或 $180^\circ$ 时，定子磁场与转子磁场同向或反向，不产生力矩（只有径向拉力）

### 3.4 $I_d$ 和 $I_q$ 的物理意义总结

在**d-q**旋转坐标系下，复杂的交流电流被分解为两个直流分量，实现了对磁场和力矩的独立控制：

| 分量名称 | 物理意义 | 对力矩T的贡献 | 控制策略 |
|---------|----------|---------------|----------|
| **$I_q$**（转矩电流） | 与 $\vec{B}$ 垂直的有效分量 | **T** 与 **$I_q$** 近似线性（T ∝ $I_q$） | 由速度环输出，精确控制力矩大小 |
| **$I_d$**（磁场电流） | 与 $\vec{B}$ 平行的分量 | 不产生电磁转矩 | 通常设为 $I_d^{ref} = 0$，用于弱磁控制时设为负值 |

### 3.5 FOC转矩方程的推导

从基本电磁原理出发，电机的电磁转矩可以表示为：

$$
T = k_T \cdot |\vec{I_s}| \cdot |\vec{B_r}| \cdot \sin(\delta)
$$

其中：

- $k_T$：与电机结构相关的常数（极对数、绕组匝数等）
- $\|\vec{I_s}\|$：定子电流矢量幅值
- $\|\vec{B_r}\|$：转子磁场强度
- $\sin(\delta)$：定子电流与转子磁场的夹角正弦值

将功角关系 $\sin(\delta) = \frac{I_q}{\|\vec{I_s}\|}$ 代入转矩公式：

$$
\begin{aligned}
T &= k_T \cdot |\vec{I_s}| \cdot |\vec{B_r}| \cdot \sin(\delta) \\
&= k_T \cdot |\vec{I_s}| \cdot |\vec{B_r}| \cdot \frac{I_q}{|\vec{I_s}|} \\
&= k_T \cdot |\vec{B_r}| \cdot I_q
\end{aligned}
$$

定义**转矩常数** $K_t = k_T \cdot \|\vec{B_r}\|$（包含磁场强度和电机结构参数），得到FOC的**核心转矩方程**：

$$
\boxed{T = K_t \cdot I_q}
$$

**方程意义**：

1. **线性关系**：转矩与 $I_q$ 成**严格线性**关系，这是FOC实现高精度力矩控制的数学基础
2. **解耦控制**：当 $I_d = 0$ 时，电机的全部电流都用于产生转矩，效率最高
3. **控制简化**：控制 $I_q$ 就等同于直接控制转矩，如同直流电机般简单

---

## 四. FOC的环路架构与电流环设计

FOC采用经典的三环嵌套结构，其**最内环（电流环）**是系统稳定性和动态响应的决定性因素。

### 4.1 FOC三环嵌套结构

目标转速 **ω_ref** 作为速度环的输入（或位置环的输出），驱动整个系统：

$$
\text{目标位置} \xrightarrow{\text{位置环}} \mathbf{\omega_{ref} (\text{目标转速})} \xrightarrow{\text{速度环}} I_{q}^{ref} (\text{目标力矩电流}) \xrightarrow{\text{电流环}} V_{q}^{ref} (\text{电压指令})
$$

**控制流程解析**：

1. **位置环**（可选）：输出目标转速 $\omega_{ref}$
2. **速度环**：根据转速误差，输出目标力矩电流 $I_q^{ref}$
3. **电流环**：跟踪 $I_q^{ref}$ 和 $I_d^{ref}$（通常为0），输出电压指令 $V_d^{ref}$、$V_q^{ref}$

### 4.2 电流环PI控制器的设计原理

电流环使用PI控制器，目标是克服电机绕组的电感 **L** 和电阻 **R_s**，驱动实际电流 **I** 快速跟踪指令 **I_ref**。

**设计方法**：工业界最常用的方法是**零极点对消法**（Zero-Pole Cancellation）。

**原理**：PI控制器的积分时间常数 **T_i** 被设计来抵消电机绕组的电气时间常数 **L/R_s**，从而将复杂的二阶系统简化为一个易于控制的一阶惯性系统。

**关键参数确定**（基于电机模型L, R_s）：

- **积分时间常数**：$T_i = \frac{L}{R_s}$
- **积分增益**：$K_i = \frac{K_p}{T_i}$
- **比例增益** $K_p$：根据期望的闭环响应时间 $\tau_{cl}$ 来确定

$$
K_p = \frac{L}{2 \cdot \tau_{cl}}
$$

> **Note**: 响应时间 $\tau_{cl}$ 越小，系统动态响应越快，但对噪声和扰动的敏感度也越高，需要权衡设计。

---

## 五. 反电动势与弱磁控制

### 5.1 反电动势与电压平衡方程

电机的运转受到**反电动势E**的制约。**E** 是随转速线性增加的干扰电压，它必须被施加电压 **V** 所克服。

#### 5.1.1 电压平衡方程的矢量形式

**FOC电压平衡方程（矢量形式）**：

$$
\vec{V}_{\text{施加}} = \vec{V}_{\text{电阻}} + \vec{V}_{\text{电感}} + \vec{V}_{\text{耦合}} + \vec{E}_{\text{反电动势}}
$$

这个方程表明，控制器施加的总电压需要克服四个部分：

1. **电阻压降**：$\vec{V}_{\text{电阻}} = R_s \vec{I}$
2. **电感电压**：$\vec{V}_{\text{电感}} = L \frac{d\vec{I}}{dt}$（电流变化引起的感应电压）
3. **耦合电压**：$\vec{V}_{\text{耦合}}$（d轴和q轴之间的交叉耦合）
4. **反电动势**：$\vec{E}_{\text{反电动势}}$（转子旋转切割磁力线产生）

在旋转坐标系（d-q坐标系）中，矢量方程可以分解为两个标量方程：

$$
\begin{aligned}
V_d &= R_s I_d + L_d \frac{dI_d}{dt} - \omega_e L_q I_q \\
V_q &= R_s I_q + L_q \frac{dI_q}{dt} + \omega_e (L_d I_d + \Psi_f)
\end{aligned}
$$

#### 5.1.2 各项物理意义详解

**d轴电压方程**：$V_d = R_s I_d + L_d \frac{dI_d}{dt} - \omega_e L_q I_q$

| 项 | 符号 | 物理意义 |
|---|------|----------|
| **施加电压** | $V_d$ | 控制器在d轴方向施加的电压（控制量） |
| **电阻压降** | $R_s I_d$ | d轴电流通过定子电阻产生的压降 |
| **电感电压** | $L_d \frac{dI_d}{dt}$ | d轴电流变化时，d轴电感产生的感应电压 |
| **交叉耦合项** | $-\omega_e L_q I_q$ | q轴电流在旋转坐标系中产生的d轴耦合电压（负号表示方向相反） |

**q轴电压方程**：$V_q = R_s I_q + L_q \frac{dI_q}{dt} + \omega_e (L_d I_d + \Psi_f)$

| 项 | 符号 | 物理意义 |
|---|------|----------|
| **施加电压** | $V_q$ | 控制器在q轴方向施加的电压（控制量） |
| **电阻压降** | $R_s I_q$ | q轴电流通过定子电阻产生的压降 |
| **电感电压** | $L_q \frac{dI_q}{dt}$ | q轴电流变化时，q轴电感产生的感应电压 |
| **交叉耦合项** | $\omega_e L_d I_d$ | d轴电流在旋转坐标系中产生的q轴耦合电压 |
| **反电动势** | $\omega_e \Psi_f$ | **转子永磁体旋转产生的反电动势**（核心干扰项） |

#### 5.1.3 稳态情况下的简化

在稳态运行时（$\frac{dI_d}{dt} = 0, \frac{dI_q}{dt} = 0$），电压方程简化为：

$$
\begin{aligned}
V_d &= R_s I_d - \omega_e L_q I_q \\
V_q &= R_s I_q + \omega_e (L_d I_d + \Psi_f)
\end{aligned}
$$

此时，控制器施加的电压主要用于：

- 克服电阻压降（$R_s I$）
- 补偿交叉耦合（$\omega_e L I$）
- **克服反电动势**（$\omega_e \Psi_f$）— **这是高速运行的主要限制**

### 5.2 控制策略：反电动势前馈补偿

高性能FOC采用**反电动势前馈补偿**，将估算出的 **E** 值提前加到PI控制器的输出上：

$$
V_{ref} = V_{PI} + E_{FF}
$$

其中：

- $V_{PI}$：PI控制器输出（用于消除电流误差）
- $E_{FF} = \omega_e \Psi_f$：前馈补偿项（抵消反电动势）

**优势**：

1. **减轻PI控制器负担**：PI控制器只需处理电流误差，不必对抗大的干扰量
2. **提升动态响应**：减少延迟，加快系统响应速度
3. **提高鲁棒性**：对转速变化的适应性更强

> **Note**: 前馈补偿的精度依赖于对 $\Psi_f$ 和 $\omega_e$ 的准确估计，参数失配会影响补偿效果。

### 5.3 PWM：将指令转化为驱动力

电流环输出的 **$V_d^{ref}, V_q^{ref}$** 最终通过坐标反变换，转化为三相电压指令，再由**SVPWM**（空间矢量脉宽调制）算法计算出逆变器功率管的精确开关占空比。

**SVPWM的优势**：

- 更高的直流电压利用率（约提升15%）
- 更低的电流谐波含量
- 更平滑的转矩输出

SVPWM确保了直流电压能够被高效、低谐波地转化为所需的交流电压，是FOC实现高性能的最后一公里。

### 5.4 完整的控制链路：从 $V_{d,q}$ 到 PWM

**步骤 1：Park逆变换（旋转坐标系 → 静止坐标系）**

$$
\begin{bmatrix} V_\alpha \\ V_\beta \end{bmatrix} = 
\begin{bmatrix} 
\cos\theta_{rotor} & -\sin\theta_{rotor} \\ 
\sin\theta_{rotor} & \cos\theta_{rotor} 
\end{bmatrix}
\begin{bmatrix} V_d \\ V_q \end{bmatrix}
$$

**物理意义**：将旋转的"虚拟线圈"的电压，转回到静止的 $\alpha-\beta$ 坐标系

**步骤 2：Clarke逆变换（两相 → 三相）**

$$
\begin{bmatrix} V_a \\ V_b \\ V_c \end{bmatrix} = 
\begin{bmatrix} 
1 & 0 \\ 
-\frac{1}{2} & \frac{\sqrt{3}}{2} \\ 
-\frac{1}{2} & -\frac{\sqrt{3}}{2} 
\end{bmatrix}
\begin{bmatrix} V_\alpha \\ V_\beta \end{bmatrix}
$$

**物理意义**：将两个正交虚拟线圈的电压，分配到实际的三相绕组

**步骤 3：SVPWM调制**

输入：$V_a, V_b, V_c$（三相电压指令）  
输出：PWM占空比 $D_a, D_b, D_c$

$$
D_i = \frac{V_i + \frac{V_{dc}}{2}}{V_{dc}} \quad (i = a, b, c)
$$

---

## 六. 影响电机带宽的因素

电机控制系统的**带宽（Bandwidth）**是衡量系统动态性能的核心指标，它决定了电机对指令变化的响应速度和控制精度。理解并优化带宽，是实现高性能FOC控制的关键。

### 6.1 带宽的定义与物理意义

#### 6.1.1 什么是带宽？

在控制系统中，**带宽**通常指系统频率响应的**-3dB截止频率**，即系统输出幅值衰减到输入信号幅值的0.707倍（约70.7%）时对应的频率点。

**物理意义**：

- **带宽越高**：系统对高频指令的跟踪能力越强，动态响应越快
- **带宽越低**：系统响应迟缓，难以跟踪快速变化的指令

对于FOC控制系统，通常关注两个关键带宽：

| 控制环 | 典型带宽范围 | 物理意义 |
|--------|--------------|----------|
| **电流环带宽** | 1000-5000 Hz | 决定力矩响应速度，影响系统的快速性和抗扰能力 |
| **速度环带宽** | 50-200 Hz | 决定转速跟踪性能，通常为电流环带宽的1/10左右 |

> **工程经验**：电流环带宽需要保证在1000Hz以上才能满足高性能应用需求。

### 6.2 影响电流环带宽的核心因素

电流环是FOC系统的**最内环**，其带宽直接决定了整个系统的动态性能上限。影响电流环带宽的因素可以分为**硬件限制**和**软件设计**两大类。

#### 6.2.1 硬件限制因素

##### （1）PWM开关频率（载波频率）

PWM开关频率是电流环带宽的**硬性上限**。

**基本原理**：

- 电流环的控制周期 $T_s = \frac{1}{f_{PWM}}$
- 根据**奈奎斯特采样定理**，电流环带宽理论上限为 $f_{PWM}/2$
- 实际工程中，考虑到计算延迟和稳定裕度，电流环带宽通常设计为：

$$
f_{current\_loop} \leq \frac{f_{PWM}}{5 \sim 10}
$$

> **权衡**：提高PWM频率可以提升带宽，但会增加开关损耗和电磁干扰（EMI）。

##### （2）电机电气参数（L和R）

电机绕组的**电感L**和**电阻R**构成了电流环的**被控对象**，它们的比值决定了系统的固有时间常数。

**电气时间常数**：
$$
\tau_e = \frac{L}{R}
$$

**影响机制**：

- **电感L越大**：电流变化越慢，系统惯性越大，带宽越低
- **电阻R越大**：阻尼越强，但也会增加损耗

> **结论**：小电感、高电阻的电机更容易实现高带宽控制。

##### （3）数字控制延迟

在数字控制系统中，从**ADC采样**到**PWM输出更新**之间存在固有的**计算延迟**。

**延迟来源**：
1. **ADC转换时间**：模拟信号转换为数字信号的时间
2. **算法运算时间**：Clarke/Park变换、PI计算、SVPWM调制等
3. **PWM更新延迟**：占空比更新需要等待下一个PWM周期

**影响**：延迟会引入**相位滞后**，降低系统稳定裕度，限制可实现的带宽上限。

#### 6.2.2 软件设计因素

##### （1）PI控制器参数整定

PI控制器的**比例增益Kp**和**积分增益Ki**直接决定了电流环的闭环带宽。

##### （2）反电动势前馈补偿

高速运行时，**反电动势**是影响电流环性能的主要扰动。

**前馈补偿策略**：
$$
V_{ref} = V_{PI} + \omega_e \Psi_f
$$

**效果**：

- 减轻PI控制器负担，提升抗扰能力
- 扩展高速区的有效带宽，改善动态响应特性

> **注意**：前馈补偿的精度依赖于电机参数（$\Psi_f$）的准确性。

##### （3）电流环饱和与抗饱和设计

当电机进入**弱磁区**或遭遇**负载突变**时，PI控制器可能输出超过电源电压的指令，导致**积分饱和**。

### 6.3 影响速度环带宽的因素

速度环的带宽通常比电流环低一个数量级，其限制因素主要来自**机械系统**和**控制策略**。

#### 6.3.1 负载惯量与传动刚度

**负载惯量**：

- 惯量越大，系统加速越慢，速度环带宽越低
- 惯量匹配不当会导致振荡

**传动刚度**：

- 传动链的**柔性**（如皮带传动、长轴）会引入机械谐振
- 谐振频率限制了速度环的最大带宽

#### 6.3.2 电流环带宽的制约

速度环的带宽必须**远低于**电流环带宽，以保证系统稳定性。

**设计原则**：

$$
f_{speed\_loop} \leq \frac{f_{current\_loop}}{5 \sim 10}
$$

**原因**：速度环的输出是电流环的输入，若两者带宽接近，会导致环路耦合，引发振荡。

### 6.4 本章小结

**核心要点**：

1. **PWM频率**是电流环带宽的硬性上限，通常取 $f_{PWM}/5 \sim f_{PWM}/10$
2. **电机电气参数**（L/R）决定了系统的固有时间常数，小电感有利于高带宽
3. **数字控制延迟**会引入相位滞后，需要通过硬件升级和算法优化来减小
4. **PI参数整定**和**前馈补偿**是软件层面提升带宽的关键手段
5. **速度环带宽**受限于电流环带宽和机械系统特性，需要协调设计

**优化路径**：

- 硬件层面：选择高开关频率的驱动器、低电感电机、高性能MCU
- 软件层面：精确整定PI参数、实施前馈补偿、设计抗饱和策略
- 系统层面：提高传动刚度、匹配负载惯量、合理设置环路带宽比例

---

## 七. 无感FOC位置估计

**无感（Sensorless）FOC** 是指在控制中不依赖物理位置传感器（如编码器），而是通过软件算法实时估算FOC所需的转子角度 **θ**。

### 7.1 有感与无感FOC对比

| FOC模式 | 优势 | 劣势 | 估算核心原理 |
|---------|------|------|--------------|
| **有感** | 零速和低速性能极佳，控制算法简单 | 成本高，可靠性依赖传感器 | 直接测量转子角度θ |
| **无感** | 降低成本、提高系统可靠性（无传感器故障） | 零速和极低速性能受限 | 中高速利用BEMF观测器；低速利用高频注入法（HFI） |

### 7.2 无感估算的核心算法

**中高速段**：

- **反电动势（BEMF）观测器**：利用测量到的电压和电流，通过电机模型反推转子位置
- 基本原理：

$$
E = K_e \cdot \omega \cdot \sin(\theta_{rotor})
$$

通过解算BEMF的相位，得到转子位置估计

**低速段**：

- **高频注入法（HFI）**：向d轴注入高频电压信号，利用电机凸极效应产生的响应电流来提取位置信息
- 适用于表贴式和内置式永磁电机

> **Note**: 无感算法的精度和鲁棒性是当前研究热点，结合滑模观测器、扩展卡尔曼滤波（EKF）等先进算法，可进一步提升性能。