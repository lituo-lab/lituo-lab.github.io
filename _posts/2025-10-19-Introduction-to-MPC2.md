---
title: MPC+LQR的飞控架构设计
date: 2025-10-19
categories: [无人机, 控制理论]
tags: [飞控, MPC, LQR, 状态空间, 控制理论]
math: true
---

## 一. 问题的起点：构建高性能飞控

在本次学习探索中，我目标是为无人机设计一套高性能的飞控系统。传统的串级 PID 控制虽然经典，但在处理约束、多变量耦合和最优性方面存在局限。为了追求更优的性能，我选择了一个先进的级联控制架构：

1. **外环（位置环）**：使用**模型预测控制 (MPC)**。MPC 擅长处理多变量系统的优化问题，并且能显式地处理输入和状态约束（如最大速度、最大倾角）。
2. **内环（姿态环）**：使用**线性二次调节器 (LQR)**。LQR 是一种基于状态空间的最优控制器，能为线性系统提供极高带宽、高鲁棒性的姿态稳定。

这篇博客将记录我从零开始设计此架构、推导公式，并深入探讨在实践中遇到的关键问题（如扰动、饱和、稳定性）的完整思考过程。

---

## 二. 经典方案介绍：串级PID

### 2.1 飞控的理想状态空间模型

$$\dot{\mathbf{x}}(t) = \mathbf{A}\mathbf{x}(t) + \mathbf{B}\mathbf{u}(t)$$

| **符号**        | **含义**     | **无人机飞控的示例**                                         |
| --------------- | ------------ | ------------------------------------------------------------ |
| $\mathbf{x}(t)$ | **状态向量** | $[x, y, z, \dot{x}, \dot{y}, \dot{z}, \phi, \theta, \psi, \dot{\phi}, \dot{\theta}, \dot{\psi}]^T$ (12个状态) |
| $\mathbf{u}(t)$ | **输入向量** | $[T, \tau_{\phi}, \tau_{\theta}, \tau_{\psi}]^T$ (总推力 $T$ 和三个力矩 $\tau$) |
| $\mathbf{A}$    | **系统矩阵** | 描述状态之间的内部耦合和自然动力学                           |
| $\mathbf{B}$    | **输入矩阵** | 描述输入对状态的影响                                         |

显然，无人机飞控系统是一个典型的MIMO系统。

### 2.2 使用PID处理MIMO系统

1. **串级控制**：通过分层设计，每一层单独的控制回路（例如，滚转角控制、俯仰角控制）都可以近似地看作是一个SISO系统，从而可以使用成熟且易于整定的PID控制器。

2. **混控解耦**：飞控内三个方向的运动相互不耦合，根据最终计算出所需的滚转力矩、俯仰力矩、偏航力矩和总升力，将这些力矩/推力需求**逆向解算**成多个电机的独立转速指令。

无人机飞控使用PID不是因为它**忽略**了飞控的MIMO特性，而是因为它通过**巧妙的系统设计和控制结构**，将复杂的MIMO控制问题**分解并近似**成了多个可以独立处理的SISO PID控制问题。

### 2.3 串级PID的一般结构

|       层级       |       控制目标       |       带宽       |                       输出                        |
| :--------------: | :------------------: | :--------------: | :-----------------------------------------------: |
| **外环**（位置） |   $p_x, p_y, p_z$    |  $5 \sim 10$ Hz  | 期望姿态 $\phi_{\text{ref}}, \theta_{\text{ref}}$ |
| **内环**（姿态） | $\phi, \theta, \psi$ | $50 \sim 100$ Hz |           期望力矩 $\tau_{\text{ref}}$            |
|   **电机分配**   |       推力合成       |        -         |           电机指令 $u_1, u_2, u_3, u_4$           |

### 2.4 串级PID的调参法则

- **核心原则**：由内到外与带宽分离，先调内环，后调外环。带宽设置参考1/3法则。
- **内环调参**：针对电机传函，调整Kp和Ki，保证最内环（角速度）的开环裕度。
- **系统验证**：通过阶跃响应和扫频测试，观察超调和震荡，进行参数微调和优化。

### 2.5 串级PID的优点

- **鲁棒性强**：内环的高带宽可以快速抑制外部扰动（如风），使外环工作在一个相对"稳定"的子系统上。
- **整定容易**：只需要分别整定内环和外环的参数。由于环与环之间存在**带宽分离**，可以近似独立整定。
- **计算简单**：适用于资源有限的嵌入式飞控硬件。

---

## 三. 核心架构：MPC-LQR 级联控制

### 3.1 外环：用于轨迹跟踪的 MPC

**目标**：跟踪期望的位置/速度轨迹 $X_{ref}$。

**模型**：我们使用简化的平动动力学模型。在小角度假设下，我们可以将无人机的**倾斜角度**（$\phi$, $\theta$）视为产生水平加速度的**控制输入**。

牛顿第二定律：

$$
m \ddot{p} = \begin{bmatrix} 0 \\ 0 \\ -mg \end{bmatrix} + R(\Phi) \begin{bmatrix} 0 \\ 0 \\ U_1 \end{bmatrix}
$$

其中 $p = [x, y, z]^T$ 是位置，$m$ 是质量，$g$ 是重力，$U_1$ 是总推力，$R(\Phi)$ 是从机体坐标系到世界坐标系的旋转矩阵。

对于 MPC，我们通常使用线性化的模型。在悬停点（$\phi \approx 0$, $\theta \approx 0$, $\psi=0$）附近进行小角度近似，动力学简化为：

$$
m \begin{bmatrix} \ddot{x} \\ \ddot{y} \\ \ddot{z} \end{bmatrix} \approx \begin{bmatrix} 0 \\ 0 \\ -mg \end{bmatrix} + \begin{bmatrix} U_1 \theta \\ -U_1 \phi \\ U_1 \end{bmatrix}
$$

进一步线性化，令 $U_1 = mg + \delta U_1$（悬停推力 + 扰动）：

$$
\ddot{x} \approx \frac{(mg + \delta U_1)}{m} \theta \approx g \theta \quad \text{(忽略高阶项 } \delta U_1 \cdot \theta \text{)}
$$

$$
\ddot{y} \approx -\frac{(mg + \delta U_1)}{m} \phi \approx -g \phi
$$

$$
\ddot{z} = \frac{mg + \delta U_1}{m} - g = \frac{\delta U_1}{m}
$$

**状态空间模型（连续时间）**：定义外环状态 $x_{outer} = [x, \dot{x}, y, \dot{y}, z, \dot{z}]^T$。定义外环控制 $u_{outer} = [\phi_d, \theta_d, \delta U_1]^T$。

$$
\dot{x}_{outer} = \underbrace{ \begin{bmatrix} 0 & 1 & 0 & 0 & 0 & 0 \\ 0 & 0 & 0 & 0 & 0 & 0 \\ 0 & 0 & 0 & 1 & 0 & 0 \\ 0 & 0 & 0 & 0 & 0 & 0 \\ 0 & 0 & 0 & 0 & 0 & 1 \\ 0 & 0 & 0 & 0 & 0 & 0 \end{bmatrix} }_{A_{cont}} x_{outer} + \underbrace{ \begin{bmatrix} 0 & 0 & 0 \\ 0 & g & 0 \\ 0 & 0 & 0 \\ -g & 0 & 0 \\ 0 & 0 & 0 \\ 0 & 0 & 1/m \end{bmatrix} }_{B_{cont}} u_{outer}
$$

**优化问题**：MPC 的核心是在每个采样周期 $k$，求解一个基于未来 $N_p$ 步的优化问题（一个二次规划 QP）：

$$
\min_{U(k)} J(k) = \sum_{i=0}^{N_p-1} \left( \|x(k+i|k) - x_{ref}(k+i)\|_Q^2 + \|u(k+i|k)\|_R^2 \right)
$$

**约束条件**：

1. $x(k+i+1\|k) = A_d x(k+i\|k) + B_d u(k+i\|k)$ (离散动力学)
2. $u_{min} \le u(k+i\|k) \le u_{max}$ (例如: $\|\phi_d\| \le \phi_{max}$)
3. $x_{min} \le x(k+i\\|k) \le x_{max}$ (例如: $z \ge z_{min}$)

**输出**：MPC 只执行最优序列的第一个控制 $u^*(k\|k)$，将其作为内环 LQR 的**参考指令** $[\phi_d, \theta_d, U_1]^T$。

### 3.2 内环：用于姿态镇定的 LQR

**目标**：快速、鲁棒地跟踪 MPC 给定的姿态指令 $[\phi_d, \theta_d, \psi_d]^T$。

**状态**：$x_{inner} = [\phi, \theta, \psi, p, q, r]^T$

**输入**：$u_{inner} = \tau = [U_2, U_3, U_4]^T$ (滚转、俯仰、偏航力矩)

**动力学方程**：

- 运动学 (角速率到欧拉角)：$\dot{\Phi} = W(\Phi) \omega$，在悬停点 ($\Phi=0$) 附近线性化有 $\dot{\Phi} \approx \omega$
- 动力学 (欧拉方程)：$I \dot{\omega} = \tau - \omega \times (I \omega)$，在悬停点 ($\omega=0$) 附近线性化有 $I \dot{\omega} \approx \tau$

**状态空间模型（连续时间）**：
$$
\dot{x}_{inner} = \underbrace{ \begin{bmatrix} 0_{3\times3} & I_{3\times3} \\ 0_{3\times3} & 0_{3\times3} \end{bmatrix} }_{A_{inner}} x_{inner} + \underbrace{ \begin{bmatrix} 0_{3\times3} \\ I_{body}^{-1} \end{bmatrix} }_{B_{inner}} u_{inner}
$$

其中 $I_{body}$ 是转动惯量矩阵（通常假设为对角阵 $diag(I_{xx}, I_{yy}, I_{zz})$），$0_{3\times3}$ 和 $I_{3\times3}$ 分别是 3x3 零矩阵和单位矩阵。

**LQR 代价函数**：LQR 旨在最小化一个无限时域的代价函数，我们控制的是误差状态 $e = x_{inner} - x_{ref}$

$$
J = \int_0^\infty (e(t)^T Q e(t) + u(t)^T R u(t)) dt
$$

$Q$ 矩阵惩罚状态误差，$R$ 矩阵惩罚控制输入。

**求解与控制律**：LQR 的解 $K$ 来自**代数黎卡提方程 (ARE)**：

$$
A^T P + P A - P B R^{-1} B^T P + Q = 0
$$

得到 $P$ 后，最优增益为 $K = R^{-1} B^T P$。

最终的控制律是一个简单的状态反馈，计算量极低：

$$
u_{lqr}(t) = -K e(t) = -K (x_{inner}(t) - x_{ref}(t))
$$

$u_{lqr}$ 即为输出的期望力矩 $[U_2, U_3, U_4]^T$

---

## 四. 思考与深潜 1：如何对抗风扰动？

> **我的困惑**：上述模型是在"真空"中设计的。如果一阵风吹来，产生了额外的"阻力"和"阻力矩"，两个环路如何协同处理的？

### 4.1 内环 (LQR)：处理"阻力矩"

- **默认鲁棒性 (P+D 特性)**：当一阵风力矩试图让飞机翻滚时，姿态 $x_{inner}$ 会偏离 $x_{ref}$。LQR 的反馈 $u = -Ke$ 会**立即**产生一个反向力矩来对抗扰动，将其"弹回"。
- **引入积分项(LQI)**：通过将积分误差 $e_I = \int (\Phi - \Phi_{ref}) dt$ 增广到状态 $x_{aug} = [x_{inner}, e_I]^T$ 中，LQI 控制器会不断累积误差，直到产生的力矩**完全抵消**恒定的风力矩，实现无静差跟踪。
- **自抗扰控制(ADRC)**：对于外界的风力矩，使用ESO进行扰动估计，在输出指令中补偿。

### 4.2 外环 (MPC)：处理"阻力"

- **默认鲁棒性 (反馈重规划)**：MPC 的**"重复优化" (Receding Horizon)** 特性是其对抗扰动的法宝。
  1. 一阵侧风 $F_{wind}$ 导致飞机偏离了预定轨迹。在**下一个**控制周期，MPC 获取到 EKF 估计的**已偏离**的**新状态** $\hat{p}(k)$。
  3. MPC 丢弃旧规划，以 $\hat{p}(k)$ 为**新起点**，重新求解一个到达 $X_{ref}$ 的最优轨迹。
  4. 为了在 $X_{ref}$ 处悬停并对抗 $F_{wind}$，MPC 会自动（为了满足模型 $\ddot{x} \approx g\theta$）计算出一个**非零的倾斜角** $\theta_d$，用这个倾斜产生的推力分量来精确抵消 $F_{wind}$。
- **使用扰动观测器 (主动补偿)**：上述方法是"被动"的（先偏离，再纠正）。
  1. 修改 MPC 模型为**增广模型**：$x(k+1) = A_d x(k) + B_d u(k) + E_d \mathbf{d(k)}$，其中 $d(k)$ 是估计的风力加速度。
  2. 观测器 (EKF 或 Luenberger) 估计出 $\hat{d}(k)$。
  3. MPC 在优化时，会**预测**到这个 $\hat{d}(k)$ 在未来将持续存在，因此它会**主动**（前馈）计算出抵消风力的倾斜角，实现更平滑、更精确的轨迹跟踪。

---

## 五. 思考与深潜 2：理论与实践的鸿沟

> **我的困惑**：理论模型是完美的，但现实是骨感的。
>
> 1. 如果电池电压下降，导致电机转速受限（饱和），怎么办？
> 2. PID 用 Bode 图看裕度，LQR 怎么保证收敛？
> 3. 业界真的用这么复杂的"全状态"控制吗？

### 5.1 现实问题：电池约束与执行器饱和

**分析**：电机转速受限 ($\omega_i \le \omega_{max}$) 会同时限制最大总推力 $U_1$ 和最大力矩 $\tau$。

**分层解决方案**：

- **外环 MPC 处理 $U_1$**：约束 $u_{min} \le u(k) \le u_{max}$ 是 MPC 的核心优势。我们必须在优化问题中加入 $U_1$ 的物理限制：

  $$
  U_{1,min} \le U_1(k) \le U_{1,max}
  $$

  更高级的， $U_{1,max}$ 可以是电池电压 $V_{batt}$ 的函数，即 $U_{1,max}(k) = f(V_{batt}(k))$。MPC 在规划时就会**主动**选择一条*可行的、较慢的*轨迹来避免 $U_1$ 饱和。

- **控制分配器处理 $\tau$**：LQR 不知道饱和的存在，它会计算出"理想"力矩。当 MPC 命令高推力 $U_1$ 且 LQR 同时命令大力矩 $\tau$ 时，**控制分配器 (Mixer)** 必须解决这个冲突。
  - **策略**：求解一个**有约束的最小二乘问题**，并设置优先级。
  - **黄金法则**：**优先保证姿态（LQR 的 $\tau$），牺牲推力（MPC 的 $U_1$）**。因为姿态失控=坠机，而推力不足=爬升慢。

### 5.2 理论问题：LQR 的收敛性保证

**分析**：PID 的稳定性由频域的**增益裕度**和**相位裕度**保证。LQR 属于状态空间方法，它的稳定性由时域的**李雅普诺夫 (Lyapunov) 稳定性理论**保证。

**LQR 的稳定性证明**：

1. LQR 求解 ARE 方程得到的解 $P$ 矩阵是正定的 ($P > 0$)。
2. 我们可以构造一个李雅普诺夫候选函数：$V(x) = x^T P x$。
3. 可以被数学证明，在 LQR 控制律 $u = -Kx$ 下，该函数的导数 $\dot{V}(x)$ 恒为负（$\dot{V}(x) < 0$）。
4. **结论**：根据李雅普诺夫第二定律，如果存在一个 $V(x)>0$ 且 $\dot{V}(x)<0$ 的函数，则系统在 $x=0$ 点是**全局渐近稳定**的。
5. 简言之：LQR 算法本身就是**在寻找一个能证明系统收敛的 $P$ 矩阵**。

### 5.3 实践问题：全状态 vs 级联控制

**分析**：为什么不把位置、姿态等 12 个状态全部放进一个"巨型"控制器？

**结论**：**级联控制（分别处理）是学术界和工业界的绝对主流。**

**原因**：

1. **时间尺度分离 (Time-Scale Separation)**：姿态（内环）的响应是毫秒级，位置（外环）的响应是秒级。将它们分开处理，允许内环以 500Hz 运行，外环以 50Hz 运行，效率最高。
2. **模型简化**：内环在悬停点附近是（近似）线性的，非常适合 LQR。外环是（轻度）非线性的（$\ddot{x} \approx g\theta$），适合 MPC。强行合并会导致一个高度非线性且耦合的复杂模型。
3. **模块化与可调性**：我可以**单独**调节 LQR 的 $Q/R$ 矩阵以获得"硬朗"的姿态响应，然后再**单独**调节 MPC 的 $Q/R$ 矩阵以获得"平滑"的轨迹跟踪。这种解耦大大降低了调试灾难。
4. **计算负载**：一个 12 维的 MPC 在线求解的计算量远大于一个 6 维 MPC + 一个 LQR 矩阵乘法。

---

## 六. 总结与反思

这次探索从一个理想的 MPC+LQR 架构出发，深入到扰动抑制、执行器饱和、稳定性证明和架构取舍等一系列实践问题。最终得到的不仅是一个控制器设计方案，更是一套完整的设计哲学：

1. **分层思想**：利用 MPC 和 LQR 各自的优势，在不同的时间尺度上处理它们各自擅长的问题（约束 vs 鲁棒）。
2. **约束意识**：MPC 主动规划以避免饱和；LQR *反馈*后由混控器被动处理饱和。
3. **理论自信**：LQR 的稳定性由李雅普诺夫理论这一坚实基础所保证。
4. **实践权衡**：级联控制（解耦）是工程上对计算负载、可调性、模型复杂度的最佳权衡。

> **Note**:  进一步关于多旋翼动力学、空间避障、轨迹规划的工作推荐学习GCOPTER。